const MAX_X=210,MIN_X=-170,POS_Y=180,MAX_Z=350,MIN_Z=20;var camera,scene,renderer,raycaster,ground_mesh,pointLight,labelRender,controls,SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,mouse=new THREE.Vector2;const clock=new THREE.Clock;var audio=new THREE.Audio(new THREE.AudioListener);const baseUrl="resources/spine/";let assetManager;var stats,last_rot,animals=[],foods=[],detectAnimalId=0,detectNum=0,markerUrls=[],markerMap={};function initStats(){eruda.init(),(stats=new Stats).setMode(0),stats.domElement.style.position="absolute",stats.domElement.style.left="0px",stats.domElement.style.top="0px",document.getElementById("scene").appendChild(stats.domElement)}function loadSpine(){0==assetManager.getToLoad()?initScene(!0):requestAnimationFrame(loadSpine)}function showStartScene(e,t){document.getElementById("start").style.visibility=e?"visible":"hidden";let n=document.getElementById("enter"),i=document.getElementById("loading"),o=document.getElementById("enter_no_scan");e?(n.style.visibility=t?"hidden":"visible",i.style.visibility=t?"visible":"hidden",o&&(o.style.visibility=t?"hidden":"visible")):(n.style.visibility="hidden",i.style.visibility="hidden",o&&(o.style.visibility="hidden"))}window.onload=function(){if(!!/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)){if(1==GAME_PARAM){showStartScene(!0,!0);let t=[];t.push(door_spine);for(const o of Object.keys(ANIMAL_CONFIG)){var e=ANIMAL_CONFIG[o];e&&e.fileName&&t.push(e.fileName)}for(const a of Object.keys(FOOD_CONFIG)){var n=FOOD_CONFIG[a];n&&n.fileName&&t.push(n.fileName)}for(const s of Object.keys(FISH_CONFIG)){var i=FISH_CONFIG[s];i&&i.fileName&&t.push(i.fileName)}assetManager=new spine.threejs.AssetManager(baseUrl);for(let e=0;e<t.length;e++)assetManager.loadText(t[e]+".json"),assetManager.loadTextureAtlas(t[e]+".atlas");requestAnimationFrame(loadSpine)}}else alert("only support in mobile phone")};var load_num=0;function initScene(){scene=new THREE.Scene,(pointLight=new THREE.PointLight(16777215,AnimationConfig.light_intensity)).position.set(0,AnimationConfig.light_height,300),scene.add(pointLight);var e=new THREE.AmbientLight(8947848);scene.add(e),(camera=new THREE.PerspectiveCamera(70,SCREEN_WIDTH/SCREEN_HEIGHT,1,3e3)).position.z=400,camera.lookAt(scene.position),scene.add(camera),(renderer=new THREE.WebGLRenderer({antialia:!0,alpha:!0})).setSize(SCREEN_WIDTH,SCREEN_HEIGHT),renderer.setPixelRatio(window.devicePixelRatio);document.getElementById("scene").appendChild(renderer.domElement),raycaster=new THREE.Raycaster;var n=new THREE.AudioLoader;for(const i of Object.keys(ANIMAL_CONFIG)){let t=ANIMAL_CONFIG[i];t&&t.audio&&(load_num++,n.load(t.audio,function(e){load_num--,t.audioBuffer=e}))}for(const o of Object.keys(FISH_CONFIG)){let t=FISH_CONFIG[o];t&&t.audio&&(load_num++,n.load(t.audio,function(e){load_num--,t.audioBuffer=e}))}load_num++,(new THREE.MTLLoader).setPath("resources/obj/background/").load("land1.mtl",function(e){e.preload(),(new THREE.OBJLoader).setMaterials(e).setPath("resources/obj/background/").load("land1.obj",function(e){load_num--,(ground_mesh=e).position.set(-5,20,0);let t=AnimationConfig.ground_scale;.6<(t=.6*window.innerWidth/window.innerHeight)&&(t=.6),ground_mesh.scale.set(t,t,t),last_rot=AnimationConfig.ground_rot_x,ground_mesh.rotateX(last_rot*Math.PI/180),scene.add(ground_mesh),ground_mesh.visible=!1},function(e){})}),initARCamera(),render(),initSettings(),initButton(),window.addEventListener("resize",function(){onResize()})}function initARCamera(){window.addEventListener("log",function(e){e.detail.iserror?console.error(e.detail.title,e.detail.msg):console.log(e.detail.title,e.detail.msg)}),window.addEventListener("arjs-nft-loaded",function(e){showStartScene(!0,!1)}),window.addEventListener("nft-marker-found",function(e){if(null!=e.detail){var t,e=markerMap[e.detail];if(null!=e){if(e!=detectAnimalId)return detectAnimalId=e,void(detectNum=0);5<++detectNum&&(detectNum=0,(t=ANIMAL_CONFIG[e])&&(t.type==ANIMAL_TYPE.DRAGON?showDragonScene(e):t.type==ANIMAL_TYPE.BEAUTY_FISH&&showBeautyFish(e)))}}}),markerUrls=[];for(const e of Object.keys(ANIMAL)){var t=ANIMAL[e],n=ANIMAL_CONFIG[t];if(n&&n.descriptorsUrls)for(let e=0;e<n.descriptorsUrls.length;e++){markerUrls.push(n.descriptorsUrls[e]);var i=markerUrls.length-1;markerMap[i]=t}}navigator.mediaDevices?initCamera().then(e=>((sourceVideo=e).width=640,sourceVideo.height=480,sourceVideo.play(),initTargetCanvas(),showARCamera(!1),new Promise(t=>{sourceVideo.addEventListener("loadeddata",e=>{t()})}))).then(e=>{start(markerUrls,video,video.videoWidth,video.videoHeight)}).catch(e=>{console.log("error",e),alert(e.message),document.getElementById("loading").style.visibility="hidden"}):(alert("please use https"),document.getElementById("loading").style.visibility="hidden")}function showARCamera(e){detectNum=detectAnimalId=0,stopProcess=!e;const t=document.querySelector("#video");t.style.opacity=e?1:0,showScanScene(e)}function showScanScene(e){document.getElementById("scan").style.visibility=e?"visible":"hidden"}function onResize(){var e=window.innerWidth,t=window.innerHeight;renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(e,t),camera.aspect=e/t,camera.updateProjectionMatrix()}function render(){stats&&stats.update();var t=clock.getDelta();for(let e=0;e<animals.length;e++)animals[e].update(t);for(let e=0;e<foods.length;e++)foods[e].update(t);render_fish(t),renderer.render(scene,camera),onResize(),requestAnimationFrame(render)}function getRandomPosition(){var e=getRandomNumber(MIN_X,MAX_X),t=getRandomNumber(MIN_Z,MAX_Z);return new THREE.Vector3(e,POS_Y,t)}function isPosLeft(e,t){e=getScreenPos(e.clone(),ground_mesh,camera);return getScreenPos(t.clone(),ground_mesh,camera).x<e.x}function setAnimalDirection(e,t){var t=isPosLeft(e.position,t),n=e.userData.animalId;return ANIMAL_CONFIG[n].flipX?e.scale.x=(t?1:-1)*Math.abs(e.scale.x):e.scale.x=(t?-1:1)*Math.abs(e.scale.x),t}function showDragonScene(e){null!=ground_mesh&&(stopProcess=!0,ground_mesh.visible=!0,null!=e&&createDragon(e),showDragonList(!(document.getElementById("info").style.visibility="visible")),showScanScene(!1))}function hideDragonScene(){audio&&audio.isPlaying&&audio.stop(),ground_mesh.visible=!1,showDragonList(!(document.getElementById("info").style.visibility="hidden")),removeAllAnimals(),removeAllFood()}var show_menu=!1;function showDragonList(e){const t=document.getElementById("dragon_list"),n=document.getElementById("dragon1"),i=document.getElementById("dragon2"),o=document.getElementById("dragon3");var a=e?"visible":"hidden";t.style.visibility=a,n.style.visibility=a,i.style.visibility=a,o.style.visibility=a,show_menu=e}function createSpineSkeleton(e,t,n=!0){var i=new spine.AtlasAttachmentLoader(assetManager.get(e+".atlas"));const o=new spine.SkeletonJson(i);i=o.readSkeletonData(assetManager.get(e+".json")),e=new spine.threejs.SkeletonMesh(i,function(e){e.depthTest=!1});return e.state.setAnimation(0,t,n),e}function createDragon(e){if(animals.length>=AnimationConfig.animal_max_num)for(let e=0;e<animals.length;e++)if(animals[e].userData.targetFoodIndex<0){removeAnimal(e);break}var t=ANIMAL_CONFIG[e];let n=createSpineSkeleton(t.fileName,Animation.STAND);var i=getRandomPosition(),i=(n.position.set(i.x,i.y,i.z),AnimationConfig.animal_min_scale);n.scale.set(i,i,i),n.userData.index=animals.length,n.userData.animalId=e,n.userData.targetFoodIndex=-1,ground_mesh.add(n),audio&&audio.isPlaying&&audio.stop(),audio.setBuffer(t.audioBuffer),audio.setLoop(!1),audio.play(),animals.push(n),nextAnimation(n)}function nextAnimation(n){n.state.timeScale=1,n.state.setAnimation(0,Animation.STAND,!0),createjs.Tween.removeTweens(n.position),createjs.Tween.get(n.position).wait(getRandomNumber(0,3e3)).call(()=>{let t=[];for(let e=0;e<foods.length;e++)checkAnimalEatFood(n.userData.animalId,foods[e].userData.foodId)&&t.push(foods[e]);var e;0<t.length?(e=Math.floor(getRandomNumber(0,t.length-1)),e=t[e].userData.index,moveToFood(n,e)):moveToNextPosition(n)})}function removeAnimalAndTween(e){createjs.Tween.removeTweens(e.position),createjs.Tween.removeTweens(e.scale),ground_mesh.remove(e)}function removeAnimal(e){if(null!=animals[e]){removeAnimalAndTween(animals[e]),animals.splice(e,1);for(let e=0;e<animals.length;e++)animals[e].userData.index=e}}function removeAllAnimals(){for(let e=0;e<animals.length;e++)removeAnimalAndTween(animals[e]);animals=[]}function moveToNextPosition(e){if(e){const n=getRandomPosition();var t=n.distanceTo(e.position);createjs.Tween.removeTweens(e.position),createjs.Tween.get(e.position,null,!0).call(()=>{setAnimalDirection(e,n),e.state.setAnimation(0,Animation.MOVE,!0),e.state.timeScale=AnimationConfig.animal_spine_speed}).to({x:n.x,z:n.z},1e3*t/AnimationConfig.animal_move_speed).call(()=>{e.state.timeScale=1,e.state.setAnimation(0,Animation.STAND,!0)}).call(()=>{nextAnimation(e)})}}function checkAnimalEatFood(e,t){var n=ANIMAL_CONFIG[e],i=FOOD_CONFIG[t];if(null==n||null==i)return!1;for(let e=0;e<n.eatFoodTypes.length;e++)if(n.eatFoodTypes[e]==i.type)return!0;return!1}function createFood(e){if(foods.length>=AnimationConfig.food_max_num)for(let e=0;e<foods.length;e++)if(foods[e].userData.canEat&&0==foods[e].userData.eatingAnimals.length){removeFood(e);break}let t=createSpineSkeleton(FOOD_CONFIG[e].fileName,Animation.STAND);var n=getRandomPosition(),n=(t.position.set(n.x,n.y+200,n.z),AnimationConfig.food_scale),i=(t.scale.set(n,n,n),t.state.timeScale=0,t.userData.foodId=e,t.userData.index=foods.length,t.userData.canEat=!1,t.userData.eatingAnimals=[],t.userData.hp=AnimationConfig.food_hp,ground_mesh.add(t),foods.push(t),t.skeleton.findBone("bone3"));i&&(i.active=!1),createjs.Tween.get(t.position,null,!0).to({y:POS_Y},300).call(()=>{if(t){t.state.timeScale=1,i.active=!0,t.userData.canEat=!0;for(let e=0;e<animals.length;e++)animals[e].userData.targetFoodIndex<0&&checkAnimalEatFood(animals[e].userData.animalId,t.userData.foodId)&&moveToFood(animals[e],t.userData.index)}})}function removeFoodAndTween(e){createjs.Tween.removeTweens(e.position),ground_mesh.remove(e)}function removeFood(e){if(null!=foods[e]){removeFoodAndTween(foods[e]),foods.splice(e,1);for(let e=0;e<foods.length;e++)foods[e].userData.index=e}}function removeAllFood(){for(let e=0;e<foods.length;e++)removeFoodAndTween(foods[e]);foods=[]}function moveToFood(e,t){const n=foods[t];if(null!=n&&n.userData.canEat){e.userData.targetFoodIndex=t,n.userData.eatingAnimals.push(e.userData.index);const s=n.position.clone();var t=isPosLeft(e.position,s),i=AnimationConfig.animal_min_scale,i=(Math.abs(e.scale.x)-i)/i,o=ANIMAL_CONFIG[e.userData.animalId],a=o.offsetX*(1+1.5*i),o=o.offsetZ*(1+1.8*i),i=(t?s.x+=a:s.x-=a,s.z+=o,setAnimalDirection(e,s),AnimationConfig.animal_eat_spead),t=(e.state.timeScale=AnimationConfig.animal_spine_speed*i,e.state.setAnimation(0,Animation.MOVE,!0),s.distanceTo(e.position));createjs.Tween.removeTweens(e.position),createjs.Tween.get(e.position,null,!0).to({x:s.x,z:s.z},1e3*t/(AnimationConfig.animal_move_speed*i)).call(()=>{eatFood(e,n)})}else moveToNextPosition(e)}function eatFood(t,n){if(null==n||!n.userData.canEat)return t.userData.targetFoodIndex=-1,void nextAnimation(t);n.userData.eatingAnimals=[],n.userData.eatingAnimals.push(t.userData.index),n.userData.canEat=!1,setAnimalDirection(t,n.position.clone()),t.state.timeScale=1,t.state.setAnimation(0,Animation.EAT,!1),--n.userData.hp;var i=t.scale.clone(),o=AnimationConfig.animal_max_scale;if(Math.abs(i.x)>=o)createjs.Tween.get(t.scale,null,!0).wait(500).call(()=>{n.userData.hp<=0?(t.userData.targetFoodIndex=-1,removeFood(n.userData.index),nextAnimation(t)):eatFood(t,n)});else{let e=Math.abs(i.x)+AnimationConfig.animal_min_scale/10;e>o&&(e=o);o=i.x<0?-1:1;createjs.Tween.get(t.scale,null,!0).wait(500).call(()=>{n.userData.hp<=0&&(t.userData.targetFoodIndex=-1,removeFood(n.userData.index))}).to({x:o*e*1.02,y:1.02*e,z:1.02*e},200).to({x:o*e,y:e,z:e},50).call(()=>{0==n.userData.hp?nextAnimation(t):eatFood(t,n)})}}var door=null,fishes=[],beautyes=[],show_fish_id=-1;function render_fish(t){for(let e=0;e<beautyes.length;e++)beautyes[e].visible&&beautyes[e].update(t);for(let e=0;e<fishes.length;e++)fishes[e].visible&&fishes[e].update(t);door&&door.visible&&door.update(t)}function showBeautyFish(t){document.getElementById("fish_scene").style.visibility="visible",document.getElementById("fish_tips").style.visibility="hidden",document.getElementById("fish_back").style.opacity=0,document.getElementById("fish_bg").style.opacity=0,showScanScene(!1),stopProcess=!0;var e,n=ANIMAL_CONFIG[t];document.getElementById("beauty_diaolog_text").innerHTML=`Hello this is ${n.name}, let's go to find other friends in the ocean togother`,document.getElementById("beauty_diaolog").style.visibility="visible";let i=null;for(let e=0;e<beautyes.length;e++)if(beautyes[e].userData.animalId==t){i=beautyes[e];break}null==i?((i=createSpineSkeleton(n.fileName,Animation.SWIM,!1)).position.set(0,-100,0),e=AnimationConfig.beauty_scale,i.scale.set(e,e,e),i.userData.animalId=t,scene.add(i),beautyes.push(i)):(i.visible=!0,i.state.setAnimation(0,Animation.SWIM,!1)),i.state.timeScale=1.5,n.audioBuffer&&(audio&&audio.isPlaying&&audio.stop(),audio.setBuffer(n.audioBuffer),audio.setLoop(!1),audio.play()),null==door&&(door=createSpineSkeleton(door_spine,Animation.STAND),e=AnimationConfig.door_scale,door.position.set(0,-200*e,-1),door.scale.set(e,e,e),scene.add(door)),door.visible=!0,setTimeout(()=>{document.getElementById("fish_tips").style.visibility="visible",document.getElementById("beauty_diaolog").style.visibility="hidden"},3800)}function showFishScene(){showARCamera(!1),document.getElementById("fish_tips").style.visibility="hidden",document.getElementById("beauty_diaolog").style.visibility="hidden",document.getElementById("fish_back").style.opacity=100,document.getElementById("fish_bg").style.opacity=100;for(let e=0;e<beautyes.length;e++)beautyes[e].visible=!1;door&&(door.visible=!1);var e=500*AnimationConfig.fish_scale,t=340*AnimationConfig.fish_scale;let n=Math.min(Math.floor(SCREEN_HEIGHT/e),7),i=[];for(let e=FISH.FISH_1;e<=FISH.FISH_7;e++)i.push(e);let o=e;for(var a=SCREEN_HEIGHT/n;0<n;){let e=Math.floor(getRandomNumber(0,i.length));e==i.length&&(e=i.length-1);var s=getRandomNumber(t,SCREEN_WIDTH-t);const l=get3DPosByScreenPos(s,o,camera);l.z=0,createFish(i[e],l),o+=a,i.splice(e,1),n--}}function HideFishScene(){audio&&audio.isPlaying&&audio.stop(),removeAllFish(),removeAllBeauty(),document.getElementById("fish_scene").style.visibility="hidden"}function removeAllBeauty(){for(let e=0;e<beautyes.length;e++)scene.remove(beautyes[e]);beautyes=[]}function createFish(t,n){var i=FISH_CONFIG[t];if(null!=i){let e=createSpineSkeleton(i.fileName,Animation.SWIM);e.position.set(n.x,n.y,n.z);i=AnimationConfig.fish_scale;e.scale.set(i,i,i),e.userData.fishId=t,e.userData.index=fishes.length,scene.add(e),fishes.push(e),fishMoveToNext(e)}}function fishMoveToNext(o){if(null!=o){var a=340*AnimationConfig.fish_scale,s=get3DPosByScreenPos(a,0,camera).x,a=get3DPosByScreenPos(SCREEN_WIDTH-a,0,camera).x,l=o.position,r=Math.abs(l.x-s),d=Math.abs(l.x-a);let e=new THREE.Vector3(r<d?a:s,l.y,l.z);r=e.y-l.y,d=e.x-l.x;let t=0;0!=d&&(t=Math.atan(r/d));let n,i;i=0<d?(n=180*Math.PI/180,-t):(n=0,t),o.rotation.z=i,createjs.Tween.removeTweens(o.rotation),createjs.Tween.get(o.rotation,null,!0).to({y:n},300),createjs.Tween.removeTweens(o.position);a=e.distanceTo(o.position);createjs.Tween.get(o.position,null,!0).wait(300).to({x:e.x,y:e.y},1e3*a/AnimationConfig.fish_move_speed).wait(getRandomNumber(0,5e3)).call(()=>{fishMoveToNext(o)})}}function removeAllFish(){for(let e=0;e<fishes.length;e++){var t=fishes[e];createjs.Tween.removeTweens(t.position),scene.remove(t)}fishes=[]}function showFishInfo(e){var t=FISH_CONFIG[e];null!=t&&(show_fish_id=e,document.getElementById("fish_info").style.visibility="visible",document.getElementById("fish_title").innerHTML=t.name,document.getElementById("fish_icon").src=t.image,document.getElementById("fish_content").innerHTML=t.description,onClickFishSound())}function hideFishInfo(){show_fish_id=-1,document.getElementById("fish_info").style.visibility="hidden"}var isTouch=!1,lastTouches=[];function initButton(){document.addEventListener("touchstart",function(e){null!=ground_mesh&&ground_mesh.visible&&(lastTouches=e.targetTouches)}),document.addEventListener("touchmove",function(e){if(e.preventDefault(),null!=ground_mesh&&ground_mesh.visible){var t,e=e.targetTouches;if(1==e.length&&1<=lastTouches.length){var n=e[0],i=lastTouches[0],n=n.clientX-i.clientX;if(!(5<Math.abs(n)))return;var i=.1*n*Math.PI/180;0!=i&&(n=AnimationConfig.ground_rot_y*Math.PI/180,i<0&&ground_mesh.rotation.y<-1*n||0<i&&ground_mesh.rotation.y>n||ground_mesh.rotateY(i))}else 2<=e.length&&2<=lastTouches.length&&(n=getTouchDistance(e[0],e[1]),i=getTouchDistance(lastTouches[0],lastTouches[1]),t=Math.abs(n-i),n<i?camera.position.z<480&&(camera.position.z+t<480?camera.position.z+=t:camera.position.z=480):i<n&&320<camera.position.z&&(320<camera.position.z-t?camera.position.z-=t:camera.position.z=320));lastTouches=e}},{passive:!1}),document.addEventListener("touchend",function(t){if(0<t.changedTouches.length){var n=t.changedTouches[0].target,n=n?n.id:"";if(show_menu&&"dragon1"!=n&&"dragon2"!=n&&"dragon3"!=n&&"dragon_list"!=n)showDragonList(!1);else if(0<show_fish_id&&"fish_info_bg"!=n&&"fish_icon"!=n&&"fish_title"!=n&&"fish_content"!=n&&"fish_sound"!=n)hideFishInfo();else if("fish_back"!=n&&"fish_move_speed"!=n&&"fish_scale"!=n){n=t.changedTouches[0].clientX,t=t.changedTouches[0].clientY;let e={};e.x=n/SCREEN_WIDTH*2-1,e.y=-t/SCREEN_HEIGHT*2+1,raycaster.setFromCamera(e,camera);n=raycaster.intersectObjects(scene.children,!0);0<n.length&&(t=n[0].object,door&&door.visible&&door==t.parent?"hidden"!=document.getElementById("fish_tips").style.visibility&&showFishScene():show_fish_id<0&&showFishInfo(t.parent.userData.fishId))}}lastTouches=[]})}function initSettings(){for(var t of Object.keys(AnimationConfig)){var n=AnimationConfig[t];let e=document.getElementById(t);e&&(e.value=n,e.onchange=e=>{var t=e.target.id,n=Number(e.target.value);if(NaN!=n&&(AnimationConfig[t]=n),"ground_scale"==t)ground_mesh.scale.set(n,n,n);else if("light_height"==t)pointLight.position.y=n;else if("light_intensity"==t)pointLight.intensity=n;else if("ground_rot_x"==t)ground_mesh.rotateX((n-last_rot)*Math.PI/180),last_rot=n;else if("fish_scale"==t)for(let e=0;e<fishes.length;e++)fishes[e].scale.set(n,n,n)})}}function onClickEnter(){showStartScene(!1),showARCamera(!0)}function onClickEnter2(){showStartScene(!1),showARCamera(!0),showBeautyFish(ANIMAL.BEAUTY_2)}function onClickBack(){showStartScene(!0,!1),showARCamera(!1),hideDragonScene()}function onClickMenu(){showDragonList(!show_menu)}function onClickMenuDragon(e){createDragon(e)}function onClickFood(){let e=Math.floor(getRandomNumber(FOOD.PORK,FOOD.CARROT+1));createFood(e=e>FOOD.CARROT?FOOD.CARROT:e)}function onClickFishBack(){0<show_fish_id?hideFishInfo():(showStartScene(!0,!1),showARCamera(!1),HideFishScene())}function onClickFishSound(){var e=FISH_CONFIG[show_fish_id];null!=e&&(audio&&audio.isPlaying&&audio.stop(),audio.setBuffer(e.audioBuffer),audio.setLoop(!1),audio.play())}